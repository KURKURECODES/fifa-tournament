<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA Tournament Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0d1117; /* Even darker background */
            color: #f3f4f6;
        }
        .main-container {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25'%3E%3Cdefs%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='0' x2='0' y1='0' y2='100%25' gradientTransform='rotate(240)'%3E%3Cstop offset='0' stop-color='%23ffffff'/%3E%3Cstop offset='1' stop-color='%234FE'/%3E%3C/linearGradient%3E%3Cpattern patternUnits='userSpaceOnUse' id='b' width='540' height='450' x='0' y='0' viewBox='0 0 1080 900'%3E%3Cg fill-opacity='0.1'%3E%3Cpolygon fill='%23444' points='90 150 0 300 180 300'/%3E%3Cpolygon points='90 150 180 0 0 0'/%3E%3Cpolygon fill='%23AAA' points='270 150 360 0 180 0'/%3E%3Cpolygon fill='%23DDD' points='450 150 360 300 540 300'/%3E%3Cpolygon fill='%23999' points='450 150 540 0 360 0'/%3E%3Cpolygon points='630 150 540 300 720 300'/%3E%3Cpolygon fill='%23DDD' points='630 150 720 0 540 0'/%3E%3Cpolygon fill='%23444' points='810 150 720 300 900 300'/%3E%3Cpolygon fill='%23FFF' points='810 150 900 0 720 0'/%3E%3Cpolygon fill='%23DDD' points='990 150 900 300 1080 300'/%3E%3Cpolygon fill='%23444' points='990 150 1080 0 900 0'/%3E%3Cpolygon fill='%23DDD' points='90 450 0 600 180 600'/%3E%3Cpolygon points='90 450 180 300 0 300'/%3E%3Cpolygon fill='%23666' points='270 450 180 600 360 600'/%3E%3Cpolygon fill='%23AAA' points='270 450 360 300 180 300'/%3E%3Cpolygon fill='%23DDD' points='450 450 360 600 540 600'/%3E%3Cpolygon fill='%23999' points='450 450 540 300 360 300'/%3E%3Cpolygon fill='%23999' points='630 450 540 600 720 600'/%3E%3Cpolygon fill='%23FFF' points='630 450 720 300 540 300'/%3E%3Cpolygon points='810 450 720 600 900 600'/%3E%3Cpolygon fill='%23DDD' points='810 450 900 300 720 300'/%3E%3Cpolygon fill='%23AAA' points='990 450 900 600 1080 600'/%3E%3Cpolygon fill='%23444' points='990 450 1080 300 900 300'/%3E%3Cpolygon fill='%23222' points='90 750 0 900 180 900'/%3E%3Cpolygon points='270 750 180 900 360 900'/%3E%3Cpolygon fill='%23DDD' points='270 750 360 600 180 600'/%3E%3Cpolygon points='450 750 540 600 360 600'/%3E%3Cpolygon points='630 750 540 900 720 900'/%3E%3Cpolygon fill='%23444' points='630 750 720 600 540 600'/%3E%3Cpolygon fill='%23AAA' points='810 750 720 900 900 900'/%3E%3Cpolygon fill='%23666' points='810 750 900 600 720 600'/%3E%3Cpolygon fill='%23999' points='990 750 900 900 1080 900'/%3E%3Cpolygon fill='%23999' points='180 0 90 150 270 150'/%3E%3Cpolygon fill='%23444' points='360 0 270 150 450 150'/%3E%3Cpolygon fill='%23FFF' points='540 0 450 150 630 150'/%3E%3Cpolygon points='900 0 810 150 990 150'/%3E%3Cpolygon fill='%23222' points='0 300 -90 450 90 450'/%3E%3Cpolygon fill='%23FFF' points='0 300 90 150 -90 150'/%3E%3Cpolygon fill='%23FFF' points='180 300 90 450 270 450'/%3E%3Cpolygon fill='%23666' points='180 300 270 150 90 150'/%3E%3Cpolygon fill='%23222' points='360 300 270 450 450 450'/%3E%3Cpolygon fill='%23FFF' points='360 300 450 150 270 150'/%3E%3Cpolygon fill='%23444' points='540 300 450 450 630 450'/%3E%3Cpolygon fill='%23222' points='540 300 630 150 450 150'/%3E%3Cpolygon fill='%23AAA' points='720 300 630 450 810 450'/%3E%3Cpolygon fill='%23666' points='720 300 810 150 630 150'/%3E%3Cpolygon fill='%23FFF' points='900 300 810 450 990 450'/%3E%3Cpolygon fill='%23999' points='900 300 990 150 810 150'/%3E%3Cpolygon points='0 600 -90 750 90 750'/%3E%3Cpolygon fill='%23666' points='0 600 90 450 -90 450'/%3E%3Cpolygon fill='%23AAA' points='180 600 90 750 270 750'/%3E%3Cpolygon fill='%23444' points='180 600 270 450 90 450'/%3E%3Cpolygon fill='%23444' points='360 600 270 750 450 750'/%3E%3Cpolygon fill='%23999' points='360 600 450 450 270 450'/%3E%3Cpolygon fill='%23666' points='540 600 630 450 450 450'/%3E%3Cpolygon fill='%23222' points='720 600 630 750 810 750'/%3E%3Cpolygon fill='%23FFF' points='900 600 810 750 990 750'/%3E%3Cpolygon fill='%23222' points='900 600 990 450 810 450'/%3E%3Cpolygon fill='%23DDD' points='0 900 90 750 -90 750'/%3E%3Cpolygon fill='%23444' points='180 900 270 750 90 750'/%3E%3Cpolygon fill='%23FFF' points='360 900 450 750 270 750'/%3E%3Cpolygon fill='%23AAA' points='540 900 630 750 450 750'/%3E%3Cpolygon fill='%23FFF' points='720 900 810 750 630 750'/%3E%3Cpolygon fill='%23222' points='900 900 990 750 810 750'/%3E%3Cpolygon fill='%23222' points='1080 300 990 450 1170 450'/%3E%3Cpolygon fill='%23FFF' points='1080 300 1170 150 990 150'/%3E%3Cpolygon points='1080 600 990 750 1170 750'/%3E%3Cpolygon fill='%23666' points='1080 600 1170 450 990 450'/%3E%3Cpolygon fill='%23DDD' points='1080 900 1170 750 990 750'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect x='0' y='0' fill='url(%23a)' width='100%25' height='100%25'/%3E%3Crect x='0' y='0' fill='url(%23b)' width='100%25' height='100%25'/%3E%3C/svg%3E");
            background-size: cover;
        }
        /* Bracket layout for desktop */
        .bracket-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 4rem;
            overflow-x: auto;
            padding: 2rem;
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex-grow: 1;
            min-width: 270px; /* Card width + spacing */
            gap: 4.5rem; 
        }
        .match {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }
        .match:hover {
            transform: scale(1.02);
        }
        .player-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: all 0.4s ease;
            width: 250px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .player-card.winner { 
            border-color: #f59e0b; 
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4), 0 0 30px rgba(236, 72, 153, 0.3); 
            transform: scale(1.05);
        }
        .player-card.loser { opacity: 0.4; filter: grayscale(80%); }
        .player-card.tbd { background-color: #374151; }
        
        /* Mobile Optimizations */
        @media (max-width: 1023px) {
            .bracket-container {
                flex-direction: column;
                gap: 1rem;
                align-items: center;
                width: 100%;
            }
            .round {
                width: 100%;
                max-width: 400px;
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            .round-title {
                text-align: center;
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            .match {
                width: 100%;
            }
        }

        .celebration-overlay { 
            background: radial-gradient(ellipse at 50% 50%, #2c3e50, #0d1117);
        }
        .celebration-image {
            width: 100%;
            max-width: 350px;
            height: auto;
            border: 3px solid #FFD700;
            border-radius: 0.75rem;
            box-shadow: 0 0 35px rgba(255, 215, 0, 0.5);
            animation: silhouette-float 4s ease-in-out infinite;
        }
        @keyframes silhouette-float { 
            0% { transform: translateY(0px) scale(1); } 
            50% { transform: translateY(-15px) scale(1.05); } 
            100% { transform: translateY(0px) scale(1); } 
        }
        .celebration-title {
             font-weight: 900;
             font-size: clamp(2.5rem, 12vw, 6rem);
             text-transform: uppercase;
             background: linear-gradient(135deg, #fef08a, #facc15, #eab308);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             animation: fadeInScale 1s ease-out forwards;
             letter-spacing: 0.1em;
        }
        .celebration-name-display {
            font-weight: 600;
            font-size: clamp(1.5rem, 8vw, 3.5rem);
            animation: fadeInDelay 1.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInDelay { from { opacity: 0; } to { opacity: 1; } }
        
        .points-table th { position: sticky; top: 0; background-color: #374151; }
        
        .btn-primary {
            background-image: linear-gradient(to right, #2563eb, #3b82f6, #60a5fa);
            background-size: 200% auto;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-position: right center;
            transform: scale(1.05);
        }
        .text-gradient-pink {
            background: linear-gradient(90deg, #ec4899, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .peer-checked\:text-gradient-pink label div {
             background: linear-gradient(90deg, #ec4899, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .peer-checked\:border-pink-500 {
            border-color: #ec4899;
        }
        
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center justify-center p-2 sm:p-4 main-container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="w-full max-w-2xl mx-auto bg-gray-800/80 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-2xl">
            <div class="text-center mb-8"><h1 class="text-4xl font-bold text-white">FIFA Tournament Setup</h1><p class="text-gray-400 mt-2">Configure your tournament and let the games begin!</p></div>
            <form id="setup-form">
                <div class="mb-6"><label class="block mb-2 text-sm font-medium text-gray-300">Tournament Type</label><div class="grid grid-cols-2 gap-4"><div><input type="radio" id="type-knockout" name="tournament-type" value="knockout" class="hidden peer" checked><label for="type-knockout" class="inline-flex items-center justify-center w-full p-3 text-gray-400 bg-gray-700 border-2 border-gray-700 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:text-blue-500 hover:text-gray-300 hover:bg-gray-600 transition-all"><div class="block"><div class="w-full text-lg font-semibold">Classic Knockout</div></div></label></div><div><input type="radio" id="type-league" name="tournament-type" value="league" class="hidden peer"><label for="type-league" class="inline-flex items-center justify-center w-full p-3 text-gray-400 bg-gray-700 border-2 border-gray-700 rounded-lg cursor-pointer peer-checked:border-pink-500 peer-checked:text-gradient-pink hover:text-gray-300 hover:bg-gray-600 transition-all"><div class="block"><div class="w-full text-lg font-semibold">League + Knockout</div></div></label></div></div></div>
                <div class="mb-6"><label for="num-teams" class="block mb-2 text-sm font-medium text-gray-300">Number of Teams</label><select id="num-teams-knockout" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option></select><input type="number" id="num-teams-league" min="4" max="16" value="7" class="hidden bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-2.5" placeholder="Enter 4-16 teams"></div>
                <div class="grid md:grid-cols-2 gap-6"><div id="players-container" class="space-y-4"><h3 class="text-xl font-semibold text-white">Player Names</h3></div><div id="clubs-container" class="space-y-4"><h3 class="text-xl font-semibold text-white">Club Pool</h3></div></div>
                <div id="resume-container" class="mt-8 text-center"></div>
                <div class="mt-4 text-center"><button type="submit" class="text-white btn-primary font-medium rounded-lg text-lg px-12 py-3 shadow-lg">Generate Tournament</button></div>
            </form>
        </div>

        <!-- League Phase Screen -->
        <div id="league-screen" class="hidden w-full max-w-7xl mx-auto">
            <header class="w-full p-4 flex justify-between items-center"><h1 class="text-3xl font-bold text-white">League Phase</h1><button id="start-knockout-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Start Knockout Phase</button></header>
            <div class="flex flex-col lg:flex-row gap-8 mt-4">
                <div class="flex-grow lg:w-3/5"><h2 class="text-2xl font-bold mb-4">Fixtures</h2><div id="fixtures-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div></div>
                <div class="flex-grow lg:w-2/5"><h2 class="text-2xl font-bold mb-4">Points Table</h2><div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden max-h-[70vh] overflow-y-auto"><table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase"><tr class="points-table"><th class="px-4 py-3">Pos</th><th class="px-6 py-3">Team</th><th class="px-2 py-3 text-center">P</th><th class="px-2 py-3 text-center">W</th><th class="px-2 py-3 text-center">D</th><th class="px-2 py-3 text-center">L</th><th class="px-2 py-3 text-center">GD</th><th class="px-2 py-3 text-center">Pts</th></tr></thead><tbody id="points-table-body"></tbody></table></div></div>
            </div>
        </div>

        <!-- Knockout Screen -->
        <div id="tournament-screen" class="hidden w-full h-full">
            <header class="w-full p-4 flex justify-between items-center bg-gray-900/50 backdrop-blur-sm fixed top-0 left-0 z-20"><h1 id="knockout-title" class="text-xl sm:text-3xl font-bold text-white">Knockout Bracket</h1><button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">New Tournament</button></header>
            <main class="flex flex-col lg:flex-row w-full mt-24"><div id="bracket-container" class="bracket-container flex-grow"></div><aside id="leaderboard-container" class="w-full lg:w-80 lg:ml-8 mt-8 lg:mt-0 p-6 bg-gray-800/80 backdrop-blur-sm rounded-2xl shadow-lg flex-shrink-0"><h2 class="text-2xl font-bold text-center mb-4 text-amber-400"><span class="inline-block mr-2">🏆</span>Golden Boot</h2><div id="leaderboard" class="space-y-3"></div></aside></main>
        </div>
    </div>

    <!-- Modals (Score, Alert, Confirm, Winner Celebration) -->
    <div id="score-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-pink-500"> <h2 id="modal-title" class="text-2xl font-bold text-center mb-6">Enter Score</h2> <form id="score-form"> <input type="hidden" id="match-identifier"> <div id="modal-body" class="space-y-4"></div> <div class="mt-8 flex justify-end space-x-4"> <button type="button" id="cancel-score" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Cancel</button> <button type="submit" class="py-2 px-6 btn-primary text-white rounded-lg transition">Submit Score</button> </div> </form> </div> </div>
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center"> <p id="custom-alert-message" class="text-white text-lg mb-6"></p> <button id="custom-alert-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg">OK</button> </div> </div>
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center"> <p id="custom-confirm-message" class="text-white text-lg mb-8"></p> <div class="flex justify-center space-x-4"> <button id="custom-confirm-no" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg">No</button> <button id="custom-confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg">Yes</button> </div> </div> </div>
    
    <!-- Golden Boot Celebration -->
    <div id="golden-boot-overlay" class="hidden fixed inset-0 z-[80] flex-col items-center justify-center celebration-overlay">
        <canvas id="confetti-canvas-gb" class="absolute top-0 left-0 w-full h-full"></canvas>
        <div class="relative text-center p-4">
            <h1 id="gb-winner-name" class="celebration-name-display"></h1>
            <h2 class="celebration-title">Golden Boot</h2>
            <img id="gb-image" src="" alt="Golden Boot Celebration" class="celebration-image mx-auto mt-4">
            <p id="gb-goal-count" class="text-2xl text-gray-300 mt-4 font-bold"></p>
        </div>
    </div>

    <!-- Champion Celebration -->
    <div id="winner-celebration-overlay" class="hidden fixed inset-0 z-[90] flex-col items-center justify-center celebration-overlay">
        <canvas id="confetti-canvas-champion" class="absolute top-0 left-0 w-full h-full"></canvas>
        <div class="relative text-center p-4">
            <h1 id="winner-name" class="celebration-name-display"></h1>
            <h2 class="champion-title">CHAMPION</h2>
            <img src="https://media.giphy.com/media/dRcb3xrnZJQmPVnY2W/giphy.gif" alt="Champion Celebration" class="celebration-image mx-auto mt-4">
            <button id="play-again-button" class="mt-12 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg text-xl transition-transform transform hover:scale-105">Play Again</button>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & SELECTORS (DECLARED BUT NOT ASSIGNED) ---
        let appContainer, screens, setupForm, numTeamsKnockout, numTeamsLeague,
            playersContainer, clubsContainer, startKnockoutButton, bracketContainer,
            leaderboard, resetButton, scoreModal, scoreForm, matchIdentifierInput,
            modalTitle, modalBody, winnerOverlay, winnerName, goldenBootOverlay,
            gbWinnerName, gbImage, gbGoalCount, championCanvas, gbCanvas, championCtx, gbCtx;
        
        let tournamentData = {};
        let confetti = [];
        let animationFrameId;

        const IMAGE_LINKS = {
            SAME_WINNER: 'https://i.guim.co.uk/img/media/0a3533a378c3a2f9091095913e77b673a5d2cb85/0_236_3500_2101/master/3500.jpg?width=1200&height=1200&quality=85&auto=format&fit=crop&s=22f55e2d3e2d19c1223963f274026d1d',
            DIFFERENT_WINNER: 'https://res.cloudinary.com/graham-media-group/image/upload/f_auto/q_auto/c_scale,w_900/v1/media/gmg/QH7OYMDQWREEDBOIEWLI6WYCK4.jpg'
        };

        // --- UTILITY & CACHING FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function saveState() {
            localStorage.setItem('fifaTournamentState', JSON.stringify(tournamentData));
        }

        function loadState() {
            const savedState = localStorage.getItem('fifaTournamentState');
            if (savedState) {
                tournamentData = JSON.parse(savedState);
                return true;
            }
            return false;
        }

        function clearState() {
            localStorage.removeItem('fifaTournamentState');
            window.location.reload();
        }

        // --- CORE APP FLOW & HANDLERS ---
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function handleSetupFormSubmit(e) {
            e.preventDefault();
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            const teamCount = parseInt(type === 'knockout' ? numTeamsKnockout.value : numTeamsLeague.value);
            
            const playerInputs = [...document.getElementsByClassName('player-name-input')];
            const clubInputs = [...document.getElementsByClassName('club-name-input')];
            let players = playerInputs.map(input => input.value.trim()).filter(Boolean);
            let clubs = clubInputs.map(input => input.value.trim()).filter(Boolean);

            if (players.length !== teamCount || clubs.length !== teamCount) {
                showCustomAlert('Please fill out all player and club names for the selected number of teams.');
                return;
            }

            const shuffledClubs = shuffleArray([...clubs]);
            tournamentData = {
                type: type,
                players: players.map((name, index) => ({ id: index, name, club: shuffledClubs[index], goals: 0, p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, pts: 0 })),
                fixtures: [], bracket: [],
                currentScreen: type,
            };
            
            if (type === 'league') {
                generateLeagueFixtures();
                renderLeagueScreen();
                switchScreen('league');
            } else {
                tournamentData.players = shuffleArray([...tournamentData.players]);
                generateKnockoutBracket(tournamentData.players);
                renderKnockoutScreen();
                switchScreen('knockout');
            }
            updateLeaderboard();
            saveState();
        }

        function handleStartKnockout() {
            const sortedPlayers = [...tournamentData.players].sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga)) || (b.gf - a.gf));
            const top4 = sortedPlayers.slice(0, 4);
            document.getElementById('knockout-title').textContent = "Final Knockout Stage";
            generateKnockoutBracket(top4);
            renderKnockoutScreen();
            switchScreen('knockout');
            tournamentData.currentScreen = 'knockout';
            saveState();
        }
        
        function handleScoreFormSubmit(e) {
            e.preventDefault();
            const identifier = matchIdentifierInput.value.split(':');
            const type = identifier[0];
            
            let values = {};
            try {
                if (type === 'league') {
                    values.s1 = parseInt(document.getElementById('p1_score_league').value);
                    values.s2 = parseInt(document.getElementById('p2_score_league').value);
                } else {
                    const match = tournamentData.bracket[parseInt(identifier[1])][parseInt(identifier[2])];
                    if (match.isSemiFinal) {
                        if (match.leg1_played) { // Entering leg 2
                             values.p1_leg2 = parseInt(document.getElementById('p1_leg2').value);
                             values.p2_leg2 = parseInt(document.getElementById('p2_leg2').value);
                        } else { // Entering leg 1
                            values.p1_leg1 = parseInt(document.getElementById('p1_leg1').value);
                            values.p2_leg1 = parseInt(document.getElementById('p2_leg1').value);
                        }
                    } else {
                        values.s1 = parseInt(document.getElementById('p1_score_knockout').value);
                        values.s2 = parseInt(document.getElementById('p2_score_knockout').value);
                    }
                }
            } catch (error) {
                 showCustomAlert('An error occurred. Please ensure the score form is correct.');
                 return;
            }

            closeScoreModal();

            if (type === 'league') {
                const { s1, s2 } = values;
                if (isNaN(s1) || isNaN(s2)) { showCustomAlert('Please enter valid scores.'); return; }
                
                const matchIndex = parseInt(identifier[1]);
                const fixture = tournamentData.fixtures[matchIndex];
                fixture.score1 = s1; fixture.score2 = s2; fixture.played = true;
                const p1 = tournamentData.players.find(p => p.id === fixture.player1.id);
                const p2 = tournamentData.players.find(p => p.id === fixture.player2.id);
                p1.p++; p2.p++; p1.gf += s1; p2.gf += s2; p1.ga += s2; p2.ga += s1; p1.goals += s1; p2.goals += s2;
                if (s1 > s2) { p1.w++; p2.l++; p1.pts += 3; }
                else if (s2 > s1) { p2.w++; p1.l++; p2.pts += 3; }
                else { p1.d++; p2.d++; p1.pts++; p2.pts++; }

                renderLeagueScreen();
                updateLeaderboard();
            } else { // knockout
                const roundIndex = parseInt(identifier[1]);
                const matchIndex = parseInt(identifier[2]);
                const match = tournamentData.bracket[roundIndex][matchIndex];
                
                if (match.isSemiFinal && !match.leg1_played) {
                    const { p1_leg1, p2_leg1 } = values;
                    if (isNaN(p1_leg1) || isNaN(p2_leg1)) { showCustomAlert('Please enter valid scores for Leg 1.'); return; }
                    match.score1_leg1 = p1_leg1;
                    match.score2_leg1 = p2_leg1;
                    match.leg1_played = true;
                    tournamentData.players.find(p => p.id === match.player1.id).goals += p1_leg1;
                    tournamentData.players.find(p => p.id === match.player2.id).goals += p2_leg1;
                    renderKnockoutScreen();
                } else {
                    let s1, s2;
                    if (match.isSemiFinal) {
                        const { p1_leg2, p2_leg2 } = values;
                        if (isNaN(p1_leg2) || isNaN(p2_leg2)) { showCustomAlert('Please enter valid scores for Leg 2.'); return; }
                        match.score1_leg2 = p1_leg2;
                        match.score2_leg2 = p2_leg2;
                        s1 = match.score1_leg1 + p1_leg2;
                        s2 = match.score2_leg1 + p2_leg2;
                        tournamentData.players.find(p => p.id === match.player1.id).goals += p1_leg2;
                        tournamentData.players.find(p => p.id === match.player2.id).goals += p2_leg2;
                    } else {
                        ({ s1, s2 } = values);
                        if (isNaN(s1) || isNaN(s2)) { showCustomAlert('Please enter valid scores.'); return; }
                        tournamentData.players.find(p => p.id === match.player1.id).goals += s1;
                        tournamentData.players.find(p => p.id === match.player2.id).goals += s2;
                        match.score1 = s1;
                        match.score2 = s2;
                    }

                    let winner = null;
                    if (s1 > s2) {
                        winner = match.player1;
                    } else if (s2 > s1) {
                        winner = match.player2;
                    } else {
                        if (match.isSemiFinal) {
                            const awayGoals1 = match.score1_leg2;
                            const awayGoals2 = match.score2_leg1;
                            if (awayGoals1 > awayGoals2) winner = match.player1;
                            else if (awayGoals2 > awayGoals1) winner = match.player2;
                        }
                        if (!winner) {
                            const message = `The match is tied. Who won on penalties?`;
                            showCustomConfirm(message, () => processKnockoutWin(match, match.player1), () => processKnockoutWin(match, match.player2), match.player1.name, match.player2.name);
                            return;
                        }
                    }
                    processKnockoutWin(match, winner);
                }
            }
            saveState();
        }

        function processKnockoutWin(match, winner) {
            match.winner = winner;
            const roundIndex = tournamentData.bracket.findIndex(round => round.includes(match));
            const matchIndex = tournamentData.bracket[roundIndex].indexOf(match);

            const isFinalMatch = roundIndex === tournamentData.bracket.length - 1;
            if (!isFinalMatch) {
                const nextMatch = tournamentData.bracket[roundIndex + 1][Math.floor(matchIndex / 2)];
                if (matchIndex % 2 === 0) nextMatch.player1 = winner;
                else nextMatch.player2 = winner;
            }
            
            renderKnockoutScreen();
            if (isFinalMatch) {
                setTimeout(() => startFinalCelebrationSequence(winner), 500);
            }
        }

        function handleBodyClick(e) {
            const target = e.target.closest('.enter-score-btn');
            if (target) {
                const matchType = target.dataset.matchType;
                if (matchType === 'league') {
                    openScoreModal(matchType, target.dataset.matchIndex);
                } else {
                    openScoreModal(matchType, target.dataset.roundIndex, target.dataset.matchIndex);
                }
            }
        }

        // --- SETUP SCREEN LOGIC ---
        function handleTournamentTypeChange() {
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            numTeamsKnockout.classList.toggle('hidden', type !== 'knockout');
            numTeamsLeague.classList.toggle('hidden', type !== 'league');
            updateInputFields();
        }

        function updateInputFields() {
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            const teamCount = parseInt(type === 'knockout' ? numTeamsKnockout.value : numTeamsLeague.value);
            
            playersContainer.innerHTML = '<h3 class="text-xl font-semibold text-white">Player Names</h3>';
            clubsContainer.innerHTML = '<h3 class="text-xl font-semibold text-white">Club Pool</h3>';
            
            const samplePlayers = ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace', 'Heidi', 'Ivan', 'Judy', 'Mallory', 'Niaj', 'Oscar', 'Peggy', 'Rupert', 'Sybil'];
            const sampleClubs = ['Real Madrid', 'FC Barcelona', 'Man United', 'Liverpool', 'Bayern Munich', 'PSG', 'Juventus', 'AC Milan', 'Inter Milan', 'Arsenal', 'Chelsea', 'Man City', 'Dortmund', 'Atletico', 'Spurs', 'Napoli'];

            for (let i = 0; i < teamCount; i++) {
                playersContainer.innerHTML += `<input type="text" placeholder="Player ${i + 1}" value="${samplePlayers[i] || ''}" class="player-name-input bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>`;
                clubsContainer.innerHTML += `<input type="text" placeholder="Club ${i + 1}" value="${sampleClubs[i] || ''}" class="club-name-input bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>`;
            }
        }
        
        // --- LEAGUE PHASE LOGIC ---
        function generateLeagueFixtures() {
            const players = [...tournamentData.players];
            if (players.length % 2 !== 0) { players.push({ name: 'BYE', id: -1 }); }
            tournamentData.fixtures = [];
            for (let round = 0; round < players.length - 1; round++) {
                for (let i = 0; i < players.length / 2; i++) {
                    const p1 = players[i]; const p2 = players[players.length - 1 - i];
                    if (p1.id !== -1 && p2.id !== -1) {
                        tournamentData.fixtures.push({ player1: p1, player2: p2, score1: null, score2: null, played: false });
                    }
                }
                players.splice(1, 0, players.pop());
            }
        }

        function renderLeagueScreen() {
            const fixturesList = document.getElementById('fixtures-list');
            const pointsTableBody = document.getElementById('points-table-body');
            fixturesList.innerHTML = '';
            pointsTableBody.innerHTML = '';

            tournamentData.fixtures.forEach((fixture, index) => {
                const scoreOrButton = fixture.played
                    ? `<div class="text-xl font-bold">${fixture.score1} - ${fixture.score2}</div>`
                    : `<button class="enter-score-btn bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="league" data-match-index="${index}">Enter Score</button>`;
                fixturesList.innerHTML += `<div class="bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg flex items-center justify-between"><div><p>${fixture.player1.name} <span class="text-xs text-gray-400">vs</span> ${fixture.player2.name}</p></div>${scoreOrButton}</div>`;
            });
            
            const sortedPlayers = [...tournamentData.players].sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga)) || (b.gf - a.gf));
            sortedPlayers.forEach((p, index) => {
                const posClass = index < 4 ? 'text-green-400 font-bold' : '';
                pointsTableBody.innerHTML += `<tr class="border-b border-gray-700"><td class="px-4 py-2 font-medium ${posClass}">${index + 1}</td><td class="px-6 py-2">${p.name} <span class="text-gray-400">(${p.club})</span></td><td class="px-2 py-2 text-center">${p.p}</td><td class="px-2 py-2 text-center">${p.w}</td><td class="px-2 py-2 text-center">${p.d}</td><td class="px-2 py-2 text-center">${p.l}</td><td class="px-2 py-2 text-center">${p.gf - p.ga}</td><td class="px-2 py-2 text-center font-bold">${p.pts}</td></tr>`;
            });

            const allPlayed = tournamentData.fixtures.every(f => f.played);
            startKnockoutButton.disabled = !allPlayed;
        }

        // --- KNOCKOUT PHASE LOGIC ---
        function generateKnockoutBracket(players) {
            const numTeams = players.length;
            if (numTeams === 0 || (numTeams > 0 && (numTeams & (numTeams - 1)) !== 0)) {
               showCustomAlert("Knockout rounds must have a number of players that is a power of 2 (e.g., 4, 8, 16).");
               return;
            }
            const numRounds = Math.log2(numTeams);
            tournamentData.bracket = [];
            let currentRoundPlayers = [...players];
            
            if (numTeams === 4 && tournamentData.type === 'league') {
                currentRoundPlayers = [players[0], players[3], players[1], players[2]];
            }

            const firstRound = [];
            for (let i = 0; i < numTeams; i += 2) {
                firstRound.push({
                    player1: currentRoundPlayers[i], player2: currentRoundPlayers[i+1], score1_leg1: null, score2_leg1: null, score1_leg2: null, score2_leg2: null, winner: null,
                    isSemiFinal: numTeams === 4, leg1_played: false
                });
            }
            tournamentData.bracket.push(firstRound);

            for (let i = 1; i < numRounds; i++) {
                const nextRound = [];
                for (let j = 0; j < tournamentData.bracket[i-1].length; j += 2) {
                    nextRound.push({ player1: null, player2: null, score1_leg1: null, score2_leg1: null, score1_leg2: null, score2_leg2: null, winner: null, isSemiFinal: (numTeams / Math.pow(2, i+1)) === 2, leg1_played: false });
                }
                tournamentData.bracket.push(nextRound);
            }
        }

        function renderKnockoutScreen() {
            bracketContainer.innerHTML = '';
            const roundNames = {16: 'Round of 16', 8: 'Quarter-Finals', 4: 'Semi-Finals', 2: 'Final'};
            const semiFinals = tournamentData.bracket.find(r => r.length * 2 === 4);
            const allLeg1Played = semiFinals ? semiFinals.every(m => m.leg1_played || m.winner) : true;

            tournamentData.bracket.forEach((round, roundIndex) => {
                const roundEl = document.createElement('div');
                roundEl.className = 'round';
                const roundName = roundNames[round.length * 2] || `Round ${roundIndex + 1}`;
                roundEl.innerHTML = `<h2 class="round-title text-gradient-pink font-bold">${roundName}</h2>`;

                round.forEach((match, matchIndex) => {
                    const matchEl = document.createElement('div');
                    matchEl.className = 'match';
                    const createPlayerCard = (player, score, winner) => {
                        if (!player) return `<div class="player-card tbd p-4 rounded-lg flex justify-between items-center"><span class="text-gray-400">TBD</span></div>`;
                        let cardClass = 'player-card';
                        if (winner) cardClass += (player === winner) ? ' winner' : ' loser';
                        const scoreDisplay = score !== null ? `<span class="text-xl font-bold ${player === winner ? 'text-amber-400' : ''}">${score}</span>` : '';
                        return `<div class="${cardClass} p-4 rounded-lg flex justify-between items-center"><div><p class="font-bold text-lg text-white">${player.name}</p><p class="text-sm text-gray-400">${player.club}</p></div>${scoreDisplay}</div>`;
                    };

                    let scoreButton = '';
                    if (match.player1 && match.player2 && !match.winner) {
                        if (match.isSemiFinal) {
                            if (!match.leg1_played) {
                                scoreButton = `<button class="enter-score-btn mt-3 bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="knockout" data-round-index="${roundIndex}" data-match-index="${matchIndex}">Enter Leg 1 Score</button>`;
                            } else if (allLeg1Played) {
                                scoreButton = `<button class="enter-score-btn mt-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="knockout" data-round-index="${roundIndex}" data-match-index="${matchIndex}">Enter Leg 2 Score</button>`;
                            }
                        } else {
                            scoreButton = `<button class="enter-score-btn mt-3 bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="knockout" data-round-index="${roundIndex}" data-match-index="${matchIndex}">Enter Score</button>`;
                        }
                    }
                    
                    const score1 = match.isSemiFinal ? match.score1_leg1 : match.score1;
                    const score2 = match.isSemiFinal ? match.score2_leg1 : match.score2;
                    let aggregateText = '';
                    if (match.isSemiFinal && match.score1_leg2 !== null) {
                        const agg1 = match.score1_leg1 + match.score1_leg2;
                        const agg2 = match.score2_leg1 + match.score2_leg2;
                        aggregateText = `<p class="text-xs text-amber-400 font-bold mt-1">Agg: ${agg1} - ${agg2}</p>`;
                    }

                    matchEl.innerHTML = `${createPlayerCard(match.player1, score1, match.winner)}<div class="text-gray-500 font-bold my-2 text-gradient-pink">${match.player1 && match.player2 ? 'VS' : ''}</div>${createPlayerCard(match.player2, score2, match.winner)}${aggregateText}${scoreButton}`;
                    
                    roundEl.appendChild(matchEl);
                });
                bracketContainer.appendChild(roundEl);
            });
            updateLeaderboard();
        }

        // --- SCORING MODAL LOGIC ---
        function openScoreModal(type, ...args) {
            let match, title;
            let identifier = type;
            modalBody.innerHTML = '';

            if (type === 'league') {
                const matchIndex = args[0];
                match = tournamentData.fixtures[matchIndex];
                identifier += `:${matchIndex}`;
                title = `${match.player1.name} vs ${match.player2.name}`;
                modalBody.innerHTML = `<div class="flex items-center justify-between"><label for="p1_score_league" class="text-lg">${match.player1.name}</label><input type="number" id="p1_score_league" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div><div class="flex items-center justify-between"><label for="p2_score_league" class="text-lg">${match.player2.name}</label><input type="number" id="p2_score_league" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div>`;
            } else { // knockout
                const [roundIndex, matchIndex] = args;
                match = tournamentData.bracket[roundIndex][matchIndex];
                identifier += `:${roundIndex}:${matchIndex}`;
                
                if (match.isSemiFinal) {
                    if (!match.leg1_played) {
                        title = `Enter Leg 1 Score: ${match.player1.name} vs ${match.player2.name}`;
                        modalBody.innerHTML = `<div class="p-4 bg-gray-700 rounded-lg"><h4 class="font-bold mb-2">Leg 1 (${match.player1.name} home)</h4><div class="flex items-center space-x-4"><label class="flex-1">${match.player1.name}:</label><input type="number" id="p1_leg1" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div><div class="flex items-center space-x-4 mt-2"><label class="flex-1">${match.player2.name}:</label><input type="number" id="p2_leg1" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div></div>`;
                    } else {
                        title = `Enter Leg 2 Score: ${match.player2.name} vs ${match.player1.name}`;
                        modalBody.innerHTML = `<p class="text-center mb-2">Leg 1: ${match.player1.name} ${match.score1_leg1} - ${match.score2_leg1} ${match.player2.name}</p><div class="p-4 bg-gray-700 rounded-lg"><h4 class="font-bold mb-2">Leg 2 (${match.player2.name} home)</h4><div class="flex items-center space-x-4"><label class="flex-1">${match.player2.name}:</label><input type="number" id="p2_leg2" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div><div class="flex items-center space-x-4 mt-2"><label class="flex-1">${match.player1.name}:</label><input type="number" id="p1_leg2" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div></div>`;
                    }
                } else {
                    title = `Enter Score: ${match.player1.name} vs ${match.player2.name}`;
                    modalBody.innerHTML = `<div class="flex items-center justify-between"><label for="p1_score_knockout" class="text-lg">${match.player1.name}</label><input type="number" id="p1_score_knockout" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div><div class="flex items-center justify-between"><label for="p2_score_knockout" class="text-lg">${match.player2.name}</label><input type="number" id="p2_score_knockout" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div>`;
                }
            }
            
            matchIdentifierInput.value = identifier;
            modalTitle.textContent = title;
            scoreModal.classList.remove('hidden');
        }
        
        function closeScoreModal() { scoreModal.classList.add('hidden'); scoreForm.reset(); }
        
        // --- LEADERBOARD & RESET ---
        function updateLeaderboard() {
            if (!leaderboard) return;
            leaderboard.innerHTML = '';
            [...tournamentData.players].sort((a, b) => b.goals - a.goals).forEach((player, index) => {
                const rankClass = index === 0 && player.goals > 0 ? 'bg-amber-500/20 border-amber-400' : 'bg-gray-700/50 border-gray-600';
                leaderboard.innerHTML += `<div class="flex justify-between items-center p-3 rounded-lg border ${rankClass}"><div class="flex items-center"><span class="font-bold w-6">${index + 1}.</span><span>${player.name}</span></div><span class="font-bold text-lg">${player.goals}</span></div>`;
            });
        }

        // --- MODALS & ANIMATIONS (Winner, Confetti, etc.) ---
        function showCustomAlert(message) { document.getElementById('custom-alert-message').textContent = message; document.getElementById('custom-alert').classList.remove('hidden'); }
        
        function showCustomConfirm(message, onYes, onNo, yesText = 'Yes', noText = 'No') {
            document.getElementById('custom-confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            const yesBtn = document.getElementById('custom-confirm-yes');
            const noBtn = document.getElementById('custom-confirm-no');
            
            yesBtn.textContent = yesText;
            noBtn.textContent = noText;

            const newYesBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            
            const newNoBtn = noBtn.cloneNode(true);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            newYesBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (onYes) onYes();
            });
            newNoBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (onNo) onNo();
            });

            confirmModal.classList.remove('hidden');
        }
        
        function startFinalCelebrationSequence(champion) {
            const topScorer = [...tournamentData.players].sort((a, b) => b.goals - a.goals)[0];
            
            gbWinnerName.textContent = topScorer.name;
            gbGoalCount.textContent = `${topScorer.goals} Goals`;
            gbImage.src = topScorer.id === champion.id ? IMAGE_LINKS.SAME_WINNER : IMAGE_LINKS.DIFFERENT_WINNER;

            goldenBootOverlay.classList.remove('hidden');
            resizeCanvas(gbCanvas);
            startConfetti(gbCtx);

            setTimeout(() => {
                goldenBootOverlay.classList.add('hidden');
                triggerChampionCelebration(champion);
            }, 5000);
        }

        function triggerChampionCelebration(winner) {
            winnerName.textContent = winner.name;
            winnerOverlay.classList.remove('hidden');
            resizeCanvas(championCanvas);
            startConfetti(championCtx);
        }
        
        function startConfetti(canvasContext) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            confetti = [];
            const confettiCount = 200;
            for(let i = 0; i < confettiCount; i++) {
                confetti.push(new ConfettiParticle(canvasContext.canvas));
            }
            animateConfetti(canvasContext);
        }

        function animateConfetti(canvasContext) {
            if(!canvasContext) return;
            canvasContext.clearRect(0, 0, canvasContext.canvas.width, canvasContext.canvas.height);
            
            confetti.forEach((p, i) => {
                p.update();
                p.draw(canvasContext);
                if (p.y > canvasContext.canvas.height) {
                    confetti.splice(i, 1);
                }
            });

            if (confetti.length > 0) {
                animationFrameId = requestAnimationFrame(() => animateConfetti(canvasContext));
            } else {
                cancelAnimationFrame(animationFrameId);
            }
        }

        function ConfettiParticle(canvas) {
            this.canvas = canvas;
            this.x = Math.random() * this.canvas.width;
            this.y = Math.random() * -this.canvas.height;
            this.w = Math.random() * 10 + 5;
            this.h = Math.random() * 20 + 10;
            this.opacity = Math.random() + 0.5;
            this.speed = Math.random() * 3 + 2;
            this.rotation = Math.random() * 360;
            this.rotationSpeed = Math.random() * 2 - 1;
            this.colors = ['#fde047', '#f59e0b', '#ffffff', '#d1d5db'];
            this.color = this.colors[Math.floor(Math.random() * this.colors.length)];

            this.update = () => {
                this.y += this.speed;
                this.rotation += this.rotationSpeed;
            };

            this.draw = (ctx) => {
                if(!ctx) return;
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x + this.w / 2, this.y + this.h / 2);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
                ctx.restore();
            };
        }

        function resizeCanvas(canvas) { 
            if(!canvas) return; 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }

        function initializeSelectors() {
            appContainer = document.getElementById('app-container');
            screens = { setup: document.getElementById('setup-screen'), league: document.getElementById('league-screen'), knockout: document.getElementById('tournament-screen') };
            setupForm = document.getElementById('setup-form');
            numTeamsKnockout = document.getElementById('num-teams-knockout');
            numTeamsLeague = document.getElementById('num-teams-league');
            playersContainer = document.getElementById('players-container');
            clubsContainer = document.getElementById('clubs-container');
            startKnockoutButton = document.getElementById('start-knockout-button');
            bracketContainer = document.getElementById('bracket-container');
            leaderboard = document.getElementById('leaderboard');
            resetButton = document.getElementById('reset-button');
            scoreModal = document.getElementById('score-modal');
            scoreForm = document.getElementById('score-form');
            matchIdentifierInput = document.getElementById('match-identifier');
            modalTitle = document.getElementById('modal-title');
            modalBody = document.getElementById('modal-body');
            winnerOverlay = document.getElementById('winner-celebration-overlay');
            winnerName = document.getElementById('winner-name');
            goldenBootOverlay = document.getElementById('golden-boot-overlay');
            gbWinnerName = document.getElementById('gb-winner-name');
            gbImage = document.getElementById('gb-image');
            gbGoalCount = document.getElementById('gb-goal-count');
            championCanvas = document.getElementById('confetti-canvas-champion');
            gbCanvas = document.getElementById('confetti-canvas-gb');
            championCtx = championCanvas ? championCanvas.getContext('2d') : null;
            gbCtx = gbCanvas ? gbCanvas.getContext('2d') : null;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeSelectors();

            const resumeContainer = document.getElementById('resume-container');
            if (localStorage.getItem('fifaTournamentState')) {
                const resumeButton = document.createElement('button');
                resumeButton.textContent = 'Resume Last Tournament';
                resumeButton.className = 'text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-lg px-12 py-3 shadow-lg transition-transform transform hover:scale-105';
                resumeButton.type = 'button'; // Prevent form submission
                resumeButton.onclick = () => {
                    if (loadState()) {
                        const screenToRender = tournamentData.currentScreen || 'knockout';
                        if (screenToRender === 'league') renderLeagueScreen();
                        else renderKnockoutScreen();
                        switchScreen(screenToRender);
                    }
                };
                resumeContainer.appendChild(resumeButton);
            }

            // --- ATTACH ALL EVENT LISTENERS ---
            setupForm.addEventListener('submit', handleSetupFormSubmit);
            startKnockoutButton.addEventListener('click', handleStartKnockout);
            scoreForm.addEventListener('submit', handleScoreFormSubmit);
            document.body.addEventListener('click', handleBodyClick);
            
            document.querySelectorAll('input[name="tournament-type"]').forEach(el => el.addEventListener('change', handleTournamentTypeChange));
            numTeamsKnockout.addEventListener('change', updateInputFields);
            numTeamsLeague.addEventListener('input', updateInputFields);
            
            resetButton.addEventListener('click', () => showCustomConfirm('Are you sure you want to start a new tournament? All progress will be lost.', clearState, null, 'Yes, Start New', 'No'));
            document.getElementById('play-again-button').addEventListener('click', clearState);
            document.getElementById('cancel-score').addEventListener('click', closeScoreModal);
            document.getElementById('custom-alert-ok').addEventListener('click', () => document.getElementById('custom-alert').classList.add('hidden'));

            // --- RUN INITIAL SETUP FUNCTIONS ---
            handleTournamentTypeChange();
            window.addEventListener('resize', () => {
                resizeCanvas(championCanvas);
                resizeCanvas(gbCanvas);
            });
        });
    </script>
</body>
</html>
