<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA Tournament Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0d1117; /* Even darker background */
            color: #f3f4f6;
        }
        .main-container {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231f2937' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: bg-scroll 80s linear infinite;
        }
        @keyframes bg-scroll {
            from { background-position: 0 0; }
            to { background-position: -500px -500px; }
        }
        .bracket-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 5rem; /* Space between rounds */
            overflow-x: auto;
            padding: 2rem;
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex-grow: 1;
            min-width: 280px;
            gap: 4rem; /* Space between matches in a round */
        }
        .match {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .match-connector {
            position: absolute;
            top: 50%;
            right: -2.5rem; /* Half of the gap */
            width: 2.5rem; /* Half of the gap */
            height: 2px;
            background-color: #4b5563;
        }
        .match-connector::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 2px;
            background-color: #4b5563;
        }
        .round > .match:nth-child(odd) .match-connector::after {
            height: calc(50% + 2rem + 1px); /* Half of match gap + half of connector height */
            bottom: 0;
        }
        .round > .match:nth-child(even) .match-connector::after {
            height: calc(50% + 2rem + 1px); /* Half of match gap + half of connector height */
            top: 0;
        }
        .player-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: all 0.3s ease;
            width: 250px;
        }
        .player-card.winner { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        .player-card.loser { opacity: 0.4; filter: grayscale(80%); }
        .player-card.tbd { background-color: #374151; }
        .final-trophy { filter: drop-shadow(0 0 20px rgba(250, 204, 21, 0.8)); transition: transform 0.5s ease-in-out; }
        .final-trophy:hover { transform: scale(1.1) rotate(5deg); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        #winner-celebration-overlay { 
            background: radial-gradient(ellipse at 50% 50%, #2c3e50, #0d1117);
        }
        .champion-silhouette {
            width: 200px;
            height: auto;
            filter: drop-shadow(0 0 35px rgba(255, 215, 0, 0.5));
            animation: silhouette-float 4s ease-in-out infinite;
        }
        @keyframes silhouette-float { 
            0% { transform: translateY(0px) scale(1); } 
            50% { transform: translateY(-15px) scale(1.05); } 
            100% { transform: translateY(0px) scale(1); } 
        }
        .champion-title {
             font-weight: 900;
             font-size: clamp(2.5rem, 12vw, 6rem);
             text-transform: uppercase;
             background: linear-gradient(135deg, #fef08a, #facc15, #eab308);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             animation: fadeInScale 1s ease-out forwards;
             letter-spacing: 0.1em;
        }
        .winner-name-display {
            font-weight: 600;
            font-size: clamp(1.5rem, 8vw, 3.5rem);
            animation: fadeInDelay 1.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInDelay { from { opacity: 0; } to { opacity: 1; } }
        
        .points-table th { position: sticky; top: 0; background-color: #374151; }
        
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center justify-center p-4 main-container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="w-full max-w-2xl mx-auto bg-gray-800/80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl">
            <div class="text-center mb-8"><h1 class="text-4xl font-bold text-white">FIFA Tournament Setup</h1><p class="text-gray-400 mt-2">Configure your tournament and let the games begin!</p></div>
            <form id="setup-form">
                <div class="mb-6"><label class="block mb-2 text-sm font-medium text-gray-300">Tournament Type</label><div class="grid grid-cols-2 gap-4"><div><input type="radio" id="type-knockout" name="tournament-type" value="knockout" class="hidden peer" checked><label for="type-knockout" class="inline-flex items-center justify-center w-full p-3 text-gray-400 bg-gray-700 border-2 border-gray-700 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:text-blue-500 hover:text-gray-300 hover:bg-gray-600"><div class="block"><div class="w-full text-lg font-semibold">Classic Knockout</div></div></label></div><div><input type="radio" id="type-league" name="tournament-type" value="league" class="hidden peer"><label for="type-league" class="inline-flex items-center justify-center w-full p-3 text-gray-400 bg-gray-700 border-2 border-gray-700 rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:text-blue-500 hover:text-gray-300 hover:bg-gray-600"><div class="block"><div class="w-full text-lg font-semibold">League + Knockout</div></div></label></div></div></div>
                <div class="mb-6"><label for="num-teams" class="block mb-2 text-sm font-medium text-gray-300">Number of Teams</label><select id="num-teams-knockout" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option></select><input type="number" id="num-teams-league" min="4" max="16" value="7" class="hidden bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Enter 4-16 teams"></div>
                <div class="grid md:grid-cols-2 gap-6"><div id="players-container" class="space-y-4"><h3 class="text-xl font-semibold text-white">Player Names</h3></div><div id="clubs-container" class="space-y-4"><h3 class="text-xl font-semibold text-white">Club Pool</h3></div></div>
                <div class="mt-8 text-center"><button type="submit" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-lg px-12 py-3 transition-transform transform hover:scale-105">Generate Tournament</button></div>
            </form>
        </div>

        <!-- League Phase Screen -->
        <div id="league-screen" class="hidden w-full max-w-7xl mx-auto">
            <header class="w-full p-4 flex justify-between items-center"><h1 class="text-3xl font-bold text-white">League Phase</h1><button id="start-knockout-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Start Knockout Phase</button></header>
            <div class="flex flex-col lg:flex-row gap-8 mt-4">
                <div class="flex-grow lg:w-3/5"><h2 class="text-2xl font-bold mb-4">Fixtures</h2><div id="fixtures-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div></div>
                <div class="flex-grow lg:w-2/5"><h2 class="text-2xl font-bold mb-4">Points Table</h2><div class="bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden max-h-[70vh] overflow-y-auto"><table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase"><tr class="points-table"><th class="px-4 py-3">Pos</th><th class="px-6 py-3">Team</th><th class="px-2 py-3 text-center">P</th><th class="px-2 py-3 text-center">W</th><th class="px-2 py-3 text-center">D</th><th class="px-2 py-3 text-center">L</th><th class="px-2 py-3 text-center">GD</th><th class="px-2 py-3 text-center">Pts</th></tr></thead><tbody id="points-table-body"></tbody></table></div></div>
            </div>
        </div>

        <!-- Knockout Screen -->
        <div id="tournament-screen" class="hidden w-full h-full">
            <header class="w-full p-4 flex justify-between items-center bg-gray-900/50 backdrop-blur-sm fixed top-0 left-0 z-20"><h1 id="knockout-title" class="text-3xl font-bold text-white">Knockout Bracket</h1><button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">New Tournament</button></header>
            <main class="flex flex-col lg:flex-row w-full mt-24"><div id="bracket-container" class="bracket-container flex-grow"></div><aside id="leaderboard-container" class="w-full lg:w-80 lg:ml-8 mt-8 lg:mt-0 p-6 bg-gray-800/80 backdrop-blur-sm rounded-2xl shadow-lg flex-shrink-0"><h2 class="text-2xl font-bold text-center mb-4 text-amber-400"><span class="inline-block mr-2">🏆</span>Golden Boot</h2><div id="leaderboard" class="space-y-3"></div></aside></main>
        </div>
    </div>

    <!-- Modals (Score, Alert, Confirm, Winner Celebration) -->
    <div id="score-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md"> <h2 id="modal-title" class="text-2xl font-bold text-center mb-6">Enter Score</h2> <form id="score-form"> <input type="hidden" id="match-identifier"> <div id="modal-body" class="space-y-4"></div> <div class="mt-8 flex justify-end space-x-4"> <button type="button" id="cancel-score" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Cancel</button> <button type="submit" class="py-2 px-6 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Submit Score</button> </div> </form> </div> </div>
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center"> <p id="custom-alert-message" class="text-white text-lg mb-6"></p> <button id="custom-alert-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg">OK</button> </div> </div>
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] p-4"> <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center"> <p id="custom-confirm-message" class="text-white text-lg mb-8"></p> <div class="flex justify-center space-x-4"> <button id="custom-confirm-no" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg">No</button> <button id="custom-confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg">Yes</button> </div> </div> </div>
    <div id="winner-celebration-overlay" class="hidden fixed inset-0 z-[90] flex-col items-center justify-center">
        <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        <div class="relative text-center">
            <h1 id="winner-name" class="winner-name-display"></h1>
            <h2 class="champion-title">CHAMPION</h2>
            <svg class="champion-silhouette mx-auto mt-4" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C12 5.10457 11.1046 6 10 6C8.89543 6 8 5.10457 8 4C8 2.89543 8.89543 2 10 2C11.1046 2 12 2.89543 12 4ZM13.8889 10.3333C13.9599 10.1242 14 9.90421 14 9.67742C14 8.20002 12.9333 7 11.5 7H8.5C7.06667 7 6 8.20002 6 9.67742C6 9.90421 6.04006 10.1242 6.11111 10.3333C4.36444 11.1111 4.22222 13.0806 4.22222 13.2097V21C4.22222 21.5523 4.66993 22 5.22222 22H14.7778C15.3301 22 15.7778 21.5523 15.7778 21V13.2097C15.7778 13.0806 15.6356 11.1111 13.8889 10.3333ZM18 10V12H21V10H18ZM17 6V8H22V6H17ZM16 2V4H23V2H16Z" fill="#FFD700"/>
            </svg>
            <button id="play-again-button" class="mt-12 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg text-xl transition-transform transform hover:scale-105">Play Again</button>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & SELECTORS (DECLARED BUT NOT ASSIGNED) ---
        let appContainer, screens, setupForm, numTeamsKnockout, numTeamsLeague,
            playersContainer, clubsContainer, startKnockoutButton, bracketContainer,
            leaderboard, resetButton, scoreModal, scoreForm, matchIdentifierInput,
            modalTitle, modalBody, winnerOverlay, winnerName, canvas, ctx;
        
        let tournamentData = {};
        let confetti = [];
        let animationFrameId;

        // --- UTILITY FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- CORE APP FLOW & HANDLERS ---
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function handleSetupFormSubmit(e) {
            e.preventDefault();
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            const teamCount = parseInt(type === 'knockout' ? numTeamsKnockout.value : numTeamsLeague.value);
            
            const playerInputs = [...document.getElementsByClassName('player-name-input')];
            const clubInputs = [...document.getElementsByClassName('club-name-input')];
            let players = playerInputs.map(input => input.value.trim()).filter(Boolean);
            let clubs = clubInputs.map(input => input.value.trim()).filter(Boolean);

            if (players.length !== teamCount || clubs.length !== teamCount) {
                showCustomAlert('Please fill out all player and club names for the selected number of teams.');
                return;
            }

            const shuffledClubs = shuffleArray(clubs);
            tournamentData = {
                type: type,
                players: players.map((name, index) => ({ id: index, name, club: shuffledClubs[index], goals: 0, p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, pts: 0 })),
                fixtures: [], bracket: [],
            };
            
            if (type === 'league') {
                generateLeagueFixtures();
                renderLeagueScreen();
                switchScreen('league');
            } else {
                tournamentData.players = shuffleArray(tournamentData.players);
                generateKnockoutBracket(tournamentData.players);
                renderKnockoutScreen();
                switchScreen('knockout');
            }
            updateLeaderboard();
        }

        function handleStartKnockout() {
            const sortedPlayers = [...tournamentData.players].sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga)) || (b.gf - a.gf));
            const top4 = sortedPlayers.slice(0, 4);
            document.getElementById('knockout-title').textContent = "Final Knockout Stage";
            generateKnockoutBracket(top4);
            renderKnockoutScreen();
            switchScreen('knockout');
        }
        
        function handleScoreFormSubmit(e) {
            e.preventDefault();
            const identifier = matchIdentifierInput.value.split(':');
            const type = identifier[0];
            
            // Read values BEFORE closing the modal
            let values = {};
            if (type === 'league') {
                values.s1 = parseInt(document.getElementById('p1_score_league').value);
                values.s2 = parseInt(document.getElementById('p2_score_league').value);
            } else { // knockout
                const match = tournamentData.bracket[parseInt(identifier[1])][parseInt(identifier[2])];
                if (match.isSemiFinal) {
                    values.p1_leg1 = parseInt(document.getElementById('p1_leg1').value);
                    values.p2_leg1 = parseInt(document.getElementById('p2_leg1').value);
                    values.p1_leg2 = parseInt(document.getElementById('p1_leg2').value);
                    values.p2_leg2 = parseInt(document.getElementById('p2_leg2').value);
                } else {
                    values.s1 = parseInt(document.getElementById('p1_score_knockout').value);
                    values.s2 = parseInt(document.getElementById('p2_score_knockout').value);
                }
            }
            
            closeScoreModal();

            if (type === 'league') {
                const { s1, s2 } = values;
                if (isNaN(s1) || isNaN(s2)) { showCustomAlert('Please enter valid scores.'); return; }
                
                const matchIndex = parseInt(identifier[1]);
                const fixture = tournamentData.fixtures[matchIndex];
                fixture.score1 = s1; fixture.score2 = s2; fixture.played = true;
                const p1 = tournamentData.players.find(p => p.id === fixture.player1.id);
                const p2 = tournamentData.players.find(p => p.id === fixture.player2.id);
                p1.p++; p2.p++; p1.gf += s1; p2.gf += s2; p1.ga += s2; p2.ga += s1; p1.goals += s1; p2.goals += s2;
                if (s1 > s2) { p1.w++; p2.l++; p1.pts += 3; }
                else if (s2 > s1) { p2.w++; p1.l++; p2.pts += 3; }
                else { p1.d++; p2.d++; p1.pts++; p2.pts++; }

                renderLeagueScreen();
                updateLeaderboard();
            } else { // knockout
                const roundIndex = parseInt(identifier[1]);
                const matchIndex = parseInt(identifier[2]);
                const match = tournamentData.bracket[roundIndex][matchIndex];
                let s1, s2;
                let p1_leg1, p2_leg1, p1_leg2, p2_leg2;

                if (match.isSemiFinal) {
                    ({ p1_leg1, p2_leg1, p1_leg2, p2_leg2 } = values);
                    if ([p1_leg1, p2_leg1, p1_leg2, p2_leg2].some(isNaN)) { showCustomAlert('Please enter scores for both legs.'); return; }
                    s1 = p1_leg1 + p1_leg2; s2 = p2_leg1 + p2_leg2;
                    tournamentData.players.find(p => p.id === match.player1.id).goals += s1;
                    tournamentData.players.find(p => p.id === match.player2.id).goals += s2;
                } else {
                    ({ s1, s2 } = values);
                    if (isNaN(s1) || isNaN(s2)) { showCustomAlert('Please enter valid scores.'); return; }
                    tournamentData.players.find(p => p.id === match.player1.id).goals += s1;
                    tournamentData.players.find(p => p.id === match.player2.id).goals += s2;
                }

                match.score1 = s1; match.score2 = s2;
                let winner = null;

                if (s1 > s2) {
                    winner = match.player1;
                } else if (s2 > s1) {
                    winner = match.player2;
                } else { // Tie logic
                    if (match.isSemiFinal) {
                        const awayGoals1 = p1_leg2; // Player 1's away goals
                        const awayGoals2 = p2_leg1; // Player 2's away goals
                        if (awayGoals1 > awayGoals2) {
                            winner = match.player1;
                        } else if (awayGoals2 > awayGoals1) {
                            winner = match.player2;
                        }
                    }
                    
                    if (!winner) { // If still tied (or not a semi-final)
                        const message = `The match is tied. Who won on penalties?`;
                        showCustomConfirm(
                            message,
                            () => processKnockoutWin(match, match.player1), // onYes
                            () => processKnockoutWin(match, match.player2), // onNo
                            match.player1.name, // Yes text
                            match.player2.name  // No text
                        );
                        return; // Stop execution, wait for user choice
                    }
                }
                processKnockoutWin(match, winner);
            }
        }

        function processKnockoutWin(match, winner) {
            match.winner = winner;
            const roundIndex = tournamentData.bracket.findIndex(round => round.includes(match));
            const matchIndex = tournamentData.bracket[roundIndex].indexOf(match);

            const isFinalMatch = roundIndex === tournamentData.bracket.length - 1;
            if (!isFinalMatch) {
                const nextMatch = tournamentData.bracket[roundIndex + 1][Math.floor(matchIndex / 2)];
                if (matchIndex % 2 === 0) {
                    nextMatch.player1 = winner;
                } else {
                    nextMatch.player2 = winner;
                }
            }
            
            renderKnockoutScreen();
            if (isFinalMatch) {
                setTimeout(() => triggerWinnerCelebration(winner), 500);
            }
        }

        function handleBodyClick(e) {
            const target = e.target.closest('.enter-score-btn');
            if (target) {
                const matchType = target.dataset.matchType;
                if (matchType === 'league') {
                    openScoreModal(matchType, target.dataset.matchIndex);
                } else {
                    openScoreModal(matchType, target.dataset.roundIndex, target.dataset.matchIndex);
                }
            }
        }

        // --- SETUP SCREEN LOGIC ---
        function handleTournamentTypeChange() {
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            numTeamsKnockout.classList.toggle('hidden', type !== 'knockout');
            numTeamsLeague.classList.toggle('hidden', type !== 'league');
            updateInputFields();
        }

        function updateInputFields() {
            const type = document.querySelector('input[name="tournament-type"]:checked').value;
            const teamCount = parseInt(type === 'knockout' ? numTeamsKnockout.value : numTeamsLeague.value);
            
            playersContainer.innerHTML = '<h3 class="text-xl font-semibold text-white">Player Names</h3>';
            clubsContainer.innerHTML = '<h3 class="text-xl font-semibold text-white">Club Pool</h3>';
            
            const samplePlayers = ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace', 'Heidi', 'Ivan', 'Judy', 'Mallory', 'Niaj', 'Oscar', 'Peggy', 'Rupert', 'Sybil'];
            const sampleClubs = ['Real Madrid', 'FC Barcelona', 'Man United', 'Liverpool', 'Bayern Munich', 'PSG', 'Juventus', 'AC Milan', 'Inter Milan', 'Arsenal', 'Chelsea', 'Man City', 'Dortmund', 'Atletico', 'Spurs', 'Napoli'];

            for (let i = 0; i < teamCount; i++) {
                playersContainer.innerHTML += `<input type="text" placeholder="Player ${i + 1}" value="${samplePlayers[i] || ''}" class="player-name-input bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>`;
                clubsContainer.innerHTML += `<input type="text" placeholder="Club ${i + 1}" value="${sampleClubs[i] || ''}" class="club-name-input bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>`;
            }
        }
        
        // --- LEAGUE PHASE LOGIC ---
        function generateLeagueFixtures() {
            const players = [...tournamentData.players];
            if (players.length % 2 !== 0) { players.push({ name: 'BYE', id: -1 }); }
            tournamentData.fixtures = [];
            for (let round = 0; round < players.length - 1; round++) {
                for (let i = 0; i < players.length / 2; i++) {
                    const p1 = players[i]; const p2 = players[players.length - 1 - i];
                    if (p1.id !== -1 && p2.id !== -1) {
                        tournamentData.fixtures.push({ player1: p1, player2: p2, score1: null, score2: null, played: false });
                    }
                }
                players.splice(1, 0, players.pop());
            }
        }

        function renderLeagueScreen() {
            const fixturesList = document.getElementById('fixtures-list');
            const pointsTableBody = document.getElementById('points-table-body');
            fixturesList.innerHTML = '';
            pointsTableBody.innerHTML = '';

            tournamentData.fixtures.forEach((fixture, index) => {
                const scoreOrButton = fixture.played
                    ? `<div class="text-xl font-bold">${fixture.score1} - ${fixture.score2}</div>`
                    : `<button class="enter-score-btn bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="league" data-match-index="${index}">Enter Score</button>`;
                fixturesList.innerHTML += `<div class="bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg flex items-center justify-between"><div><p>${fixture.player1.name} <span class="text-xs text-gray-400">vs</span> ${fixture.player2.name}</p></div>${scoreOrButton}</div>`;
            });
            
            const sortedPlayers = [...tournamentData.players].sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga)) || (b.gf - a.gf));
            sortedPlayers.forEach((p, index) => {
                const posClass = index < 4 ? 'text-green-400 font-bold' : '';
                pointsTableBody.innerHTML += `<tr class="border-b border-gray-700"><td class="px-4 py-2 font-medium ${posClass}">${index + 1}</td><td class="px-6 py-2">${p.name} <span class="text-gray-400">(${p.club})</span></td><td class="px-2 py-2 text-center">${p.p}</td><td class="px-2 py-2 text-center">${p.w}</td><td class="px-2 py-2 text-center">${p.d}</td><td class="px-2 py-2 text-center">${p.l}</td><td class="px-2 py-2 text-center">${p.gf - p.ga}</td><td class="px-2 py-2 text-center font-bold">${p.pts}</td></tr>`;
            });

            const allPlayed = tournamentData.fixtures.every(f => f.played);
            startKnockoutButton.disabled = !allPlayed;
        }

        // --- KNOCKOUT PHASE LOGIC ---
        function generateKnockoutBracket(players) {
            const numTeams = players.length;
            if (numTeams === 0 || (numTeams > 0 && (numTeams & (numTeams - 1)) !== 0)) {
               showCustomAlert("Knockout rounds must have a number of players that is a power of 2 (e.g., 4, 8, 16).");
               return;
            }
            const numRounds = Math.log2(numTeams);
            tournamentData.bracket = [];
            let currentRoundPlayers = [...players];
            
            if (numTeams === 4 && tournamentData.type === 'league') { // Specific seeding for League qualifiers: 1st vs 4th, 2nd vs 3rd
                currentRoundPlayers = [players[0], players[3], players[1], players[2]];
            }

            const firstRound = [];
            for (let i = 0; i < numTeams; i += 2) {
                firstRound.push({
                    player1: currentRoundPlayers[i], player2: currentRoundPlayers[i+1], score1: null, score2: null, winner: null,
                    isSemiFinal: numTeams === 4,
                });
            }
            tournamentData.bracket.push(firstRound);

            for (let i = 1; i < numRounds; i++) {
                const nextRound = [];
                for (let j = 0; j < tournamentData.bracket[i-1].length; j += 2) {
                    nextRound.push({ player1: null, player2: null, score1: null, score2: null, winner: null, isSemiFinal: (numTeams / Math.pow(2, i+1)) === 2 });
                }
                tournamentData.bracket.push(nextRound);
            }
        }

        function renderKnockoutScreen() {
            bracketContainer.innerHTML = '';
            const numRounds = tournamentData.bracket.length;
            tournamentData.bracket.forEach((round, roundIndex) => {
                const roundEl = document.createElement('div');
                roundEl.className = 'round';
                round.forEach((match, matchIndex) => {
                    const matchEl = document.createElement('div');
                    matchEl.className = 'match';
                    const createPlayerCard = (player, score, winner) => {
                        if (!player) return `<div class="player-card tbd p-4 rounded-lg flex justify-between items-center"><span class="text-gray-400">TBD</span></div>`;
                        let cardClass = 'player-card';
                        if (winner) cardClass += (player === winner) ? ' winner' : ' loser';
                        const scoreDisplay = score !== null ? `<span class="text-xl font-bold ${player === winner ? 'text-amber-400' : ''}">${score}</span>` : '';
                        return `<div class="${cardClass} p-4 rounded-lg flex justify-between items-center"><div><p class="font-bold text-lg text-white">${player.name}</p><p class="text-sm text-gray-400">${player.club}</p></div>${scoreDisplay}</div>`;
                    };
                    let scoreButton = (match.player1 && match.player2 && !match.winner) ? `<button class="enter-score-btn mt-3 bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-match-type="knockout" data-round-index="${roundIndex}" data-match-index="${matchIndex}">Enter Score</button>` : '';
                    matchEl.innerHTML = `${createPlayerCard(match.player1, match.score1, match.winner)}${match.player1 && match.player2 ? '<div class="text-gray-500 font-bold my-2">VS</div>' : ''}${createPlayerCard(match.player2, match.score2, match.winner)}${scoreButton}`;
                    
                    if (roundIndex < numRounds - 1) {
                         const connector = document.createElement('div');
                         connector.className = 'match-connector';
                         matchEl.appendChild(connector);
                    }

                    roundEl.appendChild(matchEl);
                });
                bracketContainer.appendChild(roundEl);
            });
            updateLeaderboard();
        }

        // --- SCORING MODAL LOGIC ---
        function openScoreModal(type, ...args) {
            let match, title;
            let identifier = type;
            modalBody.innerHTML = '';

            if (type === 'league') {
                const matchIndex = args[0];
                match = tournamentData.fixtures[matchIndex];
                identifier += `:${matchIndex}`;
                title = `${match.player1.name} vs ${match.player2.name}`;
                modalBody.innerHTML = `<div class="flex items-center justify-between"><label for="p1_score_league" class="text-lg">${match.player1.name}</label><input type="number" id="p1_score_league" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div><div class="flex items-center justify-between"><label for="p2_score_league" class="text-lg">${match.player2.name}</label><input type="number" id="p2_score_league" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div>`;
            } else { // knockout
                const [roundIndex, matchIndex] = args;
                match = tournamentData.bracket[roundIndex][matchIndex];
                identifier += `:${roundIndex}:${matchIndex}`;
                title = `Enter Score: ${match.player1.name} vs ${match.player2.name}`;
                if (match.isSemiFinal) {
                    modalBody.innerHTML = `<p class="text-lg font-semibold text-center text-amber-400">Two-Legged Semi-Final</p><div class="p-4 bg-gray-700 rounded-lg"><h4 class="font-bold mb-2">Leg 1 (${match.player1.name} home)</h4><div class="flex items-center space-x-4"><label class="flex-1">${match.player1.name}:</label><input type="number" id="p1_leg1" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div><div class="flex items-center space-x-4 mt-2"><label class="flex-1">${match.player2.name}:</label><input type="number" id="p2_leg1" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div></div><div class="p-4 bg-gray-700 rounded-lg"><h4 class="font-bold mb-2">Leg 2 (${match.player2.name} home)</h4><div class="flex items-center space-x-4"><label class="flex-1">${match.player1.name}:</label><input type="number" id="p1_leg2" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div><div class="flex items-center space-x-4 mt-2"><label class="flex-1">${match.player2.name}:</label><input type="number" id="p2_leg2" class="w-20 bg-gray-800 border border-gray-600 rounded p-2 text-center" min="0" required></div></div>`;
                } else {
                    modalBody.innerHTML = `<div class="flex items-center justify-between"><label for="p1_score_knockout" class="text-lg">${match.player1.name}</label><input type="number" id="p1_score_knockout" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div><div class="flex items-center justify-between"><label for="p2_score_knockout" class="text-lg">${match.player2.name}</label><input type="number" id="p2_score_knockout" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-center text-xl" min="0" required></div>`;
                }
            }
            
            matchIdentifierInput.value = identifier;
            modalTitle.textContent = title;
            scoreModal.classList.remove('hidden');
        }
        
        function closeScoreModal() { scoreModal.classList.add('hidden'); scoreForm.reset(); }
        
        // --- LEADERBOARD & RESET ---
        function updateLeaderboard() {
            if (!leaderboard) return;
            leaderboard.innerHTML = '';
            [...tournamentData.players].sort((a, b) => b.goals - a.goals).forEach((player, index) => {
                const rankClass = index === 0 && player.goals > 0 ? 'bg-amber-500/20 border-amber-400' : 'bg-gray-700/50 border-gray-600';
                leaderboard.innerHTML += `<div class="flex justify-between items-center p-3 rounded-lg border ${rankClass}"><div class="flex items-center"><span class="font-bold w-6">${index + 1}.</span><span>${player.name}</span></div><span class="font-bold text-lg">${player.goals}</span></div>`;
            });
        }

        // --- MODALS & ANIMATIONS (Winner, Confetti, etc.) ---
        function showCustomAlert(message) { document.getElementById('custom-alert-message').textContent = message; document.getElementById('custom-alert').classList.remove('hidden'); }
        
        function showCustomConfirm(message, onYes, onNo, yesText = 'Yes', noText = 'No') {
            document.getElementById('custom-confirm-message').textContent = message;
            const confirmModal = document.getElementById('custom-confirm');
            const yesBtn = document.getElementById('custom-confirm-yes');
            const noBtn = document.getElementById('custom-confirm-no');
            
            yesBtn.textContent = yesText;
            noBtn.textContent = noText;

            const newYesBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            
            const newNoBtn = noBtn.cloneNode(true);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            newYesBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (onYes) onYes();
            });
            newNoBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (onNo) onNo();
            });

            confirmModal.classList.remove('hidden');
        }
        
        function triggerWinnerCelebration(winner) {
            winnerName.textContent = winner.name;
            winnerOverlay.classList.remove('hidden');
            resizeCanvas();
            startConfetti();
        }
        
        function startConfetti() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            confetti = [];
            const confettiCount = 200;
            for(let i = 0; i < confettiCount; i++) {
                confetti.push(new ConfettiParticle());
            }
            animateConfetti();
        }

        function animateConfetti() {
            if(!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            confetti.forEach((p, i) => {
                p.update();
                p.draw();
                if (p.y > canvas.height) {
                    confetti.splice(i, 1);
                }
            });

            if (confetti.length > 0) {
                animationFrameId = requestAnimationFrame(animateConfetti);
            }
        }

        function ConfettiParticle() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * -canvas.height;
            this.w = Math.random() * 10 + 5;
            this.h = Math.random() * 20 + 10;
            this.opacity = Math.random() + 0.5;
            this.speed = Math.random() * 3 + 2;
            this.rotation = Math.random() * 360;
            this.rotationSpeed = Math.random() * 2 - 1;
            this.colors = ['#fde047', '#f59e0b', '#ffffff', '#d1d5db'];
            this.color = this.colors[Math.floor(Math.random() * this.colors.length)];

            this.update = () => {
                this.y += this.speed;
                this.rotation += this.rotationSpeed;
            };

            this.draw = () => {
                if(!ctx) return;
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.translate(this.x + this.w / 2, this.y + this.h / 2);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
                ctx.restore();
            };
        }

        function resizeCanvas() { 
            if(!canvas) return; 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }

        function initializeSelectors() {
            appContainer = document.getElementById('app-container');
            screens = { setup: document.getElementById('setup-screen'), league: document.getElementById('league-screen'), knockout: document.getElementById('tournament-screen') };
            setupForm = document.getElementById('setup-form');
            numTeamsKnockout = document.getElementById('num-teams-knockout');
            numTeamsLeague = document.getElementById('num-teams-league');
            playersContainer = document.getElementById('players-container');
            clubsContainer = document.getElementById('clubs-container');
            startKnockoutButton = document.getElementById('start-knockout-button');
            bracketContainer = document.getElementById('bracket-container');
            leaderboard = document.getElementById('leaderboard');
            resetButton = document.getElementById('reset-button');
            scoreModal = document.getElementById('score-modal');
            scoreForm = document.getElementById('score-form');
            matchIdentifierInput = document.getElementById('match-identifier');
            modalTitle = document.getElementById('modal-title');
            modalBody = document.getElementById('modal-body');
            winnerOverlay = document.getElementById('winner-celebration-overlay');
            winnerName = document.getElementById('winner-name');
            canvas = document.getElementById('confetti-canvas');
            ctx = canvas ? canvas.getContext('2d') : null;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeSelectors();

            // --- ATTACH ALL EVENT LISTENERS ---
            setupForm.addEventListener('submit', handleSetupFormSubmit);
            startKnockoutButton.addEventListener('click', handleStartKnockout);
            scoreForm.addEventListener('submit', handleScoreFormSubmit);
            document.body.addEventListener('click', handleBodyClick);
            
            document.querySelectorAll('input[name="tournament-type"]').forEach(el => el.addEventListener('change', handleTournamentTypeChange));
            numTeamsKnockout.addEventListener('change', updateInputFields);
            numTeamsLeague.addEventListener('input', updateInputFields);
            
            resetButton.addEventListener('click', () => showCustomConfirm('Are you sure you want to start a new tournament? All progress will be lost.', () => window.location.reload(), null, 'Yes', 'No'));
            document.getElementById('play-again-button').addEventListener('click', () => window.location.reload());
            document.getElementById('cancel-score').addEventListener('click', closeScoreModal);
            document.getElementById('custom-alert-ok').addEventListener('click', () => document.getElementById('custom-alert').classList.add('hidden'));

            // --- RUN INITIAL SETUP FUNCTIONS ---
            handleTournamentTypeChange();
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        });
    </script>
</body>
</html>
